name: Build and Release

on:
  # ç•¶æ¨é€ tag æ™‚è§¸ç™¼ï¼ˆæ‰‹å‹•å»ºç«‹ release tagï¼‰
  push:
    tags:
      - "v*"

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true
        default: "v0.1.0"

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Install uv
        run: |
          pip install uv

      - name: Install dependencies
        run: |
          uv sync

      - name: Create icon (if not exists)
        run: |
          if (-not (Test-Path "assets/icon.ico")) {
            Write-Host "Icon not found, creating new icon..."
            uv run python create_icon.py
          } else {
            Write-Host "Icon already exists, skipping creation..."
          }

      - name: Build executable with Nuitka
        run: |
          uv run nuitka --standalone --onefile --windows-console-mode=disable --windows-icon-from-ico=assets/icon.ico --include-data-dir=assets=assets --output-filename=SystemMonitor.exe --show-progress --show-memory --remove-output --assume-yes-for-downloads --plugin-enable=tk-inter --include-package=psutil --include-package=gspread --include-package=google --include-package=pystray --include-package=PIL --include-package=superyngo_logger --include-package=schedule --include-package=requests main.py

      # - name: Check build output
      #   run: |
      #     Write-Host "Current directory contents:"
      #     Get-ChildItem -Recurse | Select-Object FullName
      #     Write-Host "Checking dist directory:"
      #     if (Test-Path "dist") {
      #       Get-ChildItem -Path "dist" -Recurse | Select-Object FullName
      #     } else {
      #       Write-Host "dist directory does not exist"
      #     }
      #     Write-Host "Looking for SystemMonitor.exe:"
      #     Get-ChildItem -Name "SystemMonitor.exe" -Recurse -ErrorAction SilentlyContinue

      - name: Create release package
        run: |
          mkdir release
          # ç§»å‹• Nuitka å»ºæ§‹ç›®éŒ„åˆ° release è³‡æ–™å¤¾
          if (Test-Path "dist") {
            robocopy "dist" "release\" /E
          } else {
            Write-Host "Warning: dist directory not found"
          }


          copy config.example.json release\
          copy README.md release\

          # å»ºç«‹å£“ç¸®æª”
          Compress-Archive -Path release\* -DestinationPath SystemMonitor-${{ github.ref_name }}.zip

      - name: Verify release package
        run: |
          Write-Host "Checking release package contents:"
          if (Test-Path "SystemMonitor-${{ github.ref_name }}.zip") {
            $zipSize = (Get-Item "SystemMonitor-${{ github.ref_name }}.zip").Length
            Write-Host "ZIP file size: $zipSize bytes"
            
            # è§£å£“ç¸®ä¸¦æª¢æŸ¥å…§å®¹
            Expand-Archive -Path "SystemMonitor-${{ github.ref_name }}.zip" -DestinationPath "verify_extract" -Force
            Write-Host "ZIP contents:"
            Get-ChildItem -Path "verify_extract" -Recurse | Select-Object FullName, Length
          } else {
            Write-Host "ZIP file not found!"
            exit 1
          }

      - name: Get version from tag or input
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "push") {
            echo "version=${{ github.ref_name }}" >> $env:GITHUB_OUTPUT
          } else {
            echo "version=${{ github.event.inputs.version }}" >> $env:GITHUB_OUTPUT
          }

      - name: Create Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: System Monitor ${{ steps.version.outputs.version }}
          body: |
            ## System Monitor ${{ steps.version.outputs.version }}

            ### åŠŸèƒ½ç‰¹è‰²
            - ğŸ“Š å³æ™‚ç›£æ§ CPUã€RAM ä½¿ç”¨ç‡
            - ğŸŒ ç¶²è·¯ä½¿ç”¨é‡çµ±è¨ˆ  
            - ğŸ“ æŒ‡å®šè³‡æ–™å¤¾å…§å®¹ç›£æ§
            - â˜ï¸ è‡ªå‹•ä¸Šå‚³æ•¸æ“šåˆ° Google Sheets
            - ğŸ¯ ç³»çµ±æ‰˜ç›¤å¸¸é§ç¨‹å¼
            - âš™ï¸ ç°¡æ˜“ GUI è¨­å®šä»‹é¢

            ### å®‰è£èªªæ˜
            1. ä¸‹è¼‰ SystemMonitor-${{ steps.version.outputs.version }}.zip
            2. è§£å£“ç¸®åˆ°ä»»æ„è³‡æ–™å¤¾
            3. å°‡ config.example.json è¤‡è£½ç‚º config.json ä¸¦è¨­å®šåƒæ•¸
            4. åŸ·è¡Œ SystemMonitor.exe

            ### è®Šæ›´æ—¥èªŒ
            - è«‹æŸ¥çœ‹ commit æ­·å²äº†è§£è©³ç´°è®Šæ›´
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./SystemMonitor-${{ steps.version.outputs.version }}.zip
          asset_name: SystemMonitor-${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip
